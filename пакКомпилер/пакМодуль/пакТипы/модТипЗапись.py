# coding:utf8
"""
Модуль описывает тип-запись.
"""

if True:
	from пакКомпилер.пакСлово import тСлово
	from пакКомпилер.пакМодуль.пакТипы.модРод import тРод
	from пакКомпилер.пакМодуль.пакПоле.модПоле import тПоле

class тТипЗапись:
	def __init__(сам, пТип):
		сам.тип = пТип
		сам.поля = {} # все поля внутри записи
		сам.__Запись_Проверить()
		сам.__Поля_Проверить()
		сам.__Конец_Обрезать()

	def __Запись_Проверить(сам):
		"""
		Проверяет заголовок записи.
		Если есть предок -- заполняет предка.
		"""
		def СловоЗапись_Получить():
			строка_запись = сам.тип.Слово_Проверить()
			if строка_запись != "RECORD":
				assert False, "тТипЗапись: пропущено ключевое слово RECORD? строка=\""+строка_запись+"\""
			сам.тип.СловаСекции_Обрезать()
		def СкобкаЛевая_Обрезать():
			"""
			В этой позиции может быть скобка, а может и нет. Надо проверять.
			"""
			бРезультат = False
			строка_скобка = сам.тип.Слово_Проверить()
			if строка_скобка == "(":
				бРезультат = True
				сам.тип.СловаСекции_Обрезать()
			return бРезультат
		def СкобкаПрав_Обрезать():
				строка_скобка = сам.тип.Слово_Проверить()
				if строка_скобка != ")": # закрытие имени предка
					assert False, "тТипЗапись: пропущена закрывающая скобка предка? строка=\""+строка_скобка+"\""
				сам.тип.СловаСекции_Обрезать()
		СловоЗапись_Получить()
		if СкобкаЛевая_Обрезать():
			сам.тип.Предок_Проверить()
			СкобкаПрав_Обрезать()

	def __Поля_Проверить(сам):
		"""
		В записях ВСЕГДА встречается окончание "END" даже без
		вложенных полей.
		Поэтому здесь проверяем в цикле все поля, пока не закончатся
		"""
		строка_конец = сам.тип.Слово_Проверить()
		# если типы не встроенные (у встроенных типов нет полей)
		while строка_конец != "END": # нет окончания описания типа
			сам.тип.поля[len(сам.тип.поля)] = тПоле(сам.тип, сам)
			строка_конец = сам.тип.Слово_Проверить()

	def __Конец_Обрезать(сам):
		"""
		Здесь может встретиться только одно слово: "END".
		"""
		строка_конец = сам.тип.Слово_Проверить()
		if строка_конец == "END": # есть окончание
			сам.тип.СловаСекции_Обрезать()
		else:
			assert False, "Слово окончания типа должно быть 'END', слово=" + строка_конец
